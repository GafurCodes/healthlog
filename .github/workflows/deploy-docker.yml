name: Deploy to DigitalOcean with Docker Compose

on:
  push:
    branches:
      - main
      - feature/ci-cd

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare deployment directory
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Backup .env files if they exist
            if [ -f ~/healthlog/apps/api/.env ]; then
              cp ~/healthlog/apps/api/.env /tmp/api.env.backup
            fi
            if [ -f ~/healthlog/apps/web/.env ]; then
              cp ~/healthlog/apps/web/.env /tmp/web.env.backup
            fi

            # Remove old directory completely
            rm -rf ~/healthlog

            # Create fresh directory
            mkdir -p ~/healthlog/apps/api
            mkdir -p ~/healthlog/apps/web

            # Restore .env files if they were backed up
            if [ -f /tmp/api.env.backup ]; then
              mv /tmp/api.env.backup ~/healthlog/apps/api/.env
            fi
            if [ -f /tmp/web.env.backup ]; then
              mv /tmp/web.env.backup ~/healthlog/apps/web/.env
            fi

      - name: Copy code to droplet
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "."
          target: "~/healthlog"
          overwrite: true
          strip_components: 0

      - name: Setup Docker permissions
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Add user to docker group if not already
            if ! groups | grep -q docker; then
              echo "Adding user to docker group..."
              sudo usermod -aG docker $USER
            fi

            # Check if docker compose works with sudo
            if ! sudo docker compose version &> /dev/null; then
              echo "Docker Compose not found, installing..."

              # Install Docker Compose plugin system-wide
              sudo mkdir -p /usr/local/lib/docker/cli-plugins
              sudo curl -SL https://github.com/docker/compose/releases/download/v2.24.5/docker-compose-linux-x86_64 -o /usr/local/lib/docker/cli-plugins/docker-compose
              sudo chmod +x /usr/local/lib/docker/cli-plugins/docker-compose

              echo "Docker Compose installed successfully"
            else
              echo "Docker Compose already installed"
            fi

            # Verify installation
            sudo docker compose version

      - name: Deploy with Docker Compose
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ~/healthlog

            # Rebuild and restart containers (using sudo)
            sudo docker compose down
            sudo docker compose build --no-cache
            sudo docker compose up -d

            # Show status
            sudo docker compose ps
